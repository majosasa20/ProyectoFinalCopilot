using Microsoft.AspNetCore.Mvc;
using AdventureWorks.Enterprise.Api.Models.Production;

namespace AdventureWorks.Enterprise.Api.Controllers
{
    /// <summary>
    /// Controlador para la gestión de productos e inventario
    /// </summary>
    [ApiController]
    [Route("api/[controller]")]
    public class ProductosController : ControllerBase
    {
        private readonly ILogger<ProductosController> _logger;
        private static List<ProductDto> _productos = new();
        private static List<ProductInventoryDto> _inventario = new();

        public ProductosController(ILogger<ProductosController> logger)
        {
            _logger = logger;
        }

        /// <summary>
        /// Obtener todos los productos
        /// </summary>
        /// <returns>Lista de productos</returns>
        [HttpGet]
        public async Task<ActionResult<IEnumerable<ProductDto>>> ObtenerProductos()
        {
            try
            {
                _logger.LogInformation("Obteniendo todos los productos en {Timestamp}", DateTime.UtcNow);
                return Ok(_productos);
            }
            catch (Exception ex)
            {
                _logger.LogError(ex, "Error al obtener los productos");
                return StatusCode(500, "Ocurrió un error al procesar su solicitud");
            }
        }

        /// <summary>
        /// Obtener producto por ID
        /// </summary>
        /// <param name="id">ID del producto</param>
        /// <returns>Detalles del producto</returns>
        [HttpGet("{id}")]
        public async Task<ActionResult<ProductDto>> ObtenerProducto(int id)
        {
            try
            {
                _logger.LogInformation("Obteniendo producto {ProductoId} en {Timestamp}", id, DateTime.UtcNow);
                
                var producto = _productos.FirstOrDefault(p => p.ProductID == id);
                if (producto == null)
                {
                    _logger.LogWarning("Producto {ProductoId} no encontrado", id);
                    return NotFound($"Producto con ID {id} no encontrado");
                }

                return Ok(producto);
            }
            catch (Exception ex)
            {
                _logger.LogError(ex, "Error al obtener el producto {ProductoId}", id);
                return StatusCode(500, "Ocurrió un error al procesar su solicitud");
            }
        }

        /// <summary>
        /// Obtener inventario del producto
        /// </summary>
        /// <param name="id">ID del producto</param>
        /// <returns>Detalles del inventario del producto</returns>
        [HttpGet("{id}/inventario")]
        public async Task<ActionResult<IEnumerable<ProductInventoryDto>>> ObtenerInventarioProducto(int id)
        {
            try
            {
                _logger.LogInformation("Obteniendo inventario para producto {ProductoId} en {Timestamp}", id, DateTime.UtcNow);
                
                var inventario = _inventario.Where(i => i.ProductID == id).ToList();
                return Ok(inventario);
            }
            catch (Exception ex)
            {
                _logger.LogError(ex, "Error al obtener inventario para producto {ProductoId}", id);
                return StatusCode(500, "Ocurrió un error al procesar su solicitud");
            }
        }

        /// <summary>
        /// Crear un nuevo producto
        /// </summary>
        /// <param name="producto">Datos del producto</param>
        /// <returns>Producto creado</returns>
        [HttpPost]
        public async Task<ActionResult<ProductDto>> CrearProducto([FromBody] ProductDto producto)
        {
            try
            {
                if (!ModelState.IsValid)
                {
                    _logger.LogWarning("Estado del modelo inválido para crear producto");
                    return BadRequest(ModelState);
                }

                producto.ProductID = _productos.Count > 0 ? _productos.Max(p => p.ProductID) + 1 : 1;
                producto.RowGuid = Guid.NewGuid();
                producto.ModifiedDate = DateTime.UtcNow;

                _productos.Add(producto);
                
                _logger.LogInformation("Producto {ProductoId} creado en {Timestamp}", producto.ProductID, DateTime.UtcNow);
                
                return CreatedAtAction(nameof(ObtenerProducto), new { id = producto.ProductID }, producto);
            }
            catch (Exception ex)
            {
                _logger.LogError(ex, "Error al crear el producto");
                return StatusCode(500, "Ocurrió un error al procesar su solicitud");
            }
        }

        /// <summary>
        /// Actualizar un producto existente
        /// </summary>
        /// <param name="id">ID del producto</param>
        /// <param name="producto">Datos actualizados del producto</param>
        /// <returns>Sin contenido si es exitoso</returns>
        [HttpPut("{id}")]
        public async Task<IActionResult> ActualizarProducto(int id, [FromBody] ProductDto producto)
        {
            try
            {
                if (!ModelState.IsValid)
                {
                    _logger.LogWarning("Estado del modelo inválido para actualizar producto {ProductoId}", id);
                    return BadRequest(ModelState);
                }

                var productoExistente = _productos.FirstOrDefault(p => p.ProductID == id);
                if (productoExistente == null)
                {
                    _logger.LogWarning("Producto {ProductoId} no encontrado para actualizar", id);
                    return NotFound($"Producto con ID {id} no encontrado");
                }

                // Actualizar propiedades
                productoExistente.Name = producto.Name;
                productoExistente.ProductNumber = producto.ProductNumber;
                productoExistente.MakeFlag = producto.MakeFlag;
                productoExistente.FinishedGoodsFlag = producto.FinishedGoodsFlag;
                productoExistente.Color = producto.Color;
                productoExistente.SafetyStockLevel = producto.SafetyStockLevel;
                productoExistente.ReorderPoint = producto.ReorderPoint;
                productoExistente.StandardCost = producto.StandardCost;
                productoExistente.ListPrice = producto.ListPrice;
                productoExistente.Size = producto.Size;
                productoExistente.Weight = producto.Weight;
                productoExistente.DaysToManufacture = producto.DaysToManufacture;
                productoExistente.ProductLine = producto.ProductLine;
                productoExistente.Class = producto.Class;
                productoExistente.Style = producto.Style;
                productoExistente.SellStartDate = producto.SellStartDate;
                productoExistente.SellEndDate = producto.SellEndDate;
                productoExistente.DiscontinuedDate = producto.DiscontinuedDate;
                productoExistente.ModifiedDate = DateTime.UtcNow;

                _logger.LogInformation("Producto {ProductoId} actualizado en {Timestamp}", id, DateTime.UtcNow);
                
                return NoContent();
            }
            catch (Exception ex)
            {
                _logger.LogError(ex, "Error al actualizar el producto {ProductoId}", id);
                return StatusCode(500, "Ocurrió un error al procesar su solicitud");
            }
        }

        /// <summary>
        /// Eliminar un producto
        /// </summary>
        /// <param name="id">ID del producto</param>
        /// <returns>Sin contenido si es exitoso</returns>
        [HttpDelete("{id}")]
        public async Task<IActionResult> EliminarProducto(int id)
        {
            try
            {
                var producto = _productos.FirstOrDefault(p => p.ProductID == id);
                if (producto == null)
                {
                    _logger.LogWarning("Producto {ProductoId} no encontrado para eliminar", id);
                    return NotFound($"Producto con ID {id} no encontrado");
                }

                _productos.Remove(producto);
                
                _logger.LogInformation("Producto {ProductoId} eliminado en {Timestamp}", id, DateTime.UtcNow);
                
                return NoContent();
            }
            catch (Exception ex)
            {
                _logger.LogError(ex, "Error al eliminar el producto {ProductoId}", id);
                return StatusCode(500, "Ocurrió un error al procesar su solicitud");
            }
        }

        /// <summary>
        /// Actualizar inventario del producto
        /// </summary>
        /// <param name="id">ID del producto</param>
        /// <param name="inventario">Datos del inventario</param>
        /// <returns>Sin contenido si es exitoso</returns>
        [HttpPut("{id}/inventario")]
        public async Task<IActionResult> ActualizarInventario(int id, [FromBody] ProductInventoryDto inventario)
        {
            try
            {
                if (!ModelState.IsValid)
                {
                    _logger.LogWarning("Estado del modelo inválido para actualizar inventario del producto {ProductoId}", id);
                    return BadRequest(ModelState);
                }

                var inventarioExistente = _inventario.FirstOrDefault(i => i.ProductID == id && i.LocationID == inventario.LocationID);
                if (inventarioExistente == null)
                {
                    // Crear nuevo registro de inventario
                    inventario.ProductID = id;
                    inventario.RowGuid = Guid.NewGuid();
                    inventario.ModifiedDate = DateTime.UtcNow;
                    _inventario.Add(inventario);
                    
                    _logger.LogInformation("Inventario creado para producto {ProductoId} en ubicación {UbicacionId}", id, inventario.LocationID);
                }
                else
                {
                    // Actualizar inventario existente
                    inventarioExistente.Shelf = inventario.Shelf;
                    inventarioExistente.Bin = inventario.Bin;
                    inventarioExistente.Quantity = inventario.Quantity;
                    inventarioExistente.ModifiedDate = DateTime.UtcNow;
                    
                    _logger.LogInformation("Inventario actualizado para producto {ProductoId} en ubicación {UbicacionId}", id, inventario.LocationID);
                }

                return NoContent();
            }
            catch (Exception ex)
            {
                _logger.LogError(ex, "Error al actualizar inventario para producto {ProductoId}", id);
                return StatusCode(500, "Ocurrió un error al procesar su solicitud");
            }
        }

        /// <summary>
        /// Obtener productos por categoría
        /// </summary>
        /// <param name="categoriaId">ID de la categoría de producto</param>
        /// <returns>Lista de productos en la categoría</returns>
        [HttpGet("categoria/{categoriaId}")]
        public async Task<ActionResult<IEnumerable<ProductDto>>> ObtenerProductosPorCategoria(int categoriaId)
        {
            try
            {
                _logger.LogInformation("Obteniendo productos para categoría {CategoriaId} en {Timestamp}", categoriaId, DateTime.UtcNow);
                
                var productosCategoria = _productos.Where(p => p.ProductSubcategoryID == categoriaId).ToList();
                return Ok(productosCategoria);
            }
            catch (Exception ex)
            {
                _logger.LogError(ex, "Error al obtener productos para categoría {CategoriaId}", categoriaId);
                return StatusCode(500, "Ocurrió un error al procesar su solicitud");
            }
        }
    }
}